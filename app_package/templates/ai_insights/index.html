{% extends 'base.html' %}
{% block title %}AI Insights{% endblock %}

{% block extra_css %}
<style>
    .health-gauge {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        position: relative;
    }
    .health-gauge-inner {
        width: 88px;
        height: 88px;
        border-radius: 50%;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .health-gauge-inner .score {
        font-size: 1.75rem;
        font-weight: 800;
        line-height: 1;
    }
    .health-gauge-inner .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.7;
    }
    .dim-bar {
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        overflow: hidden;
        margin-bottom: 0.4rem;
    }
    .dim-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.6s ease;
    }
    .insight-panel {
        display: none;
    }
    .insight-panel.show {
        display: block;
    }
    .insight-section {
        border-left: 3px solid;
        padding-left: 0.75rem;
        margin-bottom: 1rem;
    }
    .insight-section.working { border-color: #198754; }
    .insight-section.improve { border-color: #ffc107; }
    .insight-section.actions { border-color: #7209b7; }
    .url-platform-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #fff;
        transition: all 0.3s ease;
    }
    .score-card {
        transition: transform 0.2s;
    }
    .score-card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="mb-1"><i class="bi bi-stars text-warning"></i> AI Insights</h4>
        <p class="text-muted mb-0">Health scores &amp; AI-powered recommendations for your social pages</p>
    </div>
</div>

<!-- Section A: Analyze Any Page URL -->
<div class="card card-custom mb-4">
    <div class="card-body">
        <h6 class="mb-3"><i class="bi bi-link-45deg"></i> Analyze Any Page</h6>
        <p class="text-muted small mb-3">Enter any Facebook, Instagram, or LinkedIn page URL to get AI-powered insights. No connection required.</p>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text" id="url-platform-badge">
                        <i class="bi bi-globe"></i>
                    </span>
                    <input type="url" class="form-control" id="pageUrl" placeholder="https://facebook.com/yourpage" oninput="detectPlatform(this.value)">
                </div>
            </div>
            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-3">
                        <input type="number" class="form-control form-control-sm" id="urlFollowers" placeholder="Followers" min="0">
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control form-control-sm" id="urlAvgLikes" placeholder="Avg Likes" min="0">
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control form-control-sm" id="urlAvgComments" placeholder="Avg Comments" min="0">
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control form-control-sm" id="urlPostsPerWeek" placeholder="Posts/wk" min="0" step="0.5">
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary" id="analyzeUrlBtn" onclick="analyzeUrl()" {% if not has_api_key %}disabled title="Set OPENAI_API_KEY in .env to enable"{% endif %}>
                <i class="bi bi-magic"></i> Analyze Page
            </button>
            <span class="text-muted small ms-2">Optional metrics improve accuracy</span>
        </div>

        <!-- URL Analysis Result -->
        <div id="urlResult" class="mt-4" style="display:none;">
            <hr>
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="health-gauge" id="urlGauge">
                        <div class="health-gauge-inner">
                            <span class="score" id="urlScore">--</span>
                            <span class="label" id="urlLabel">--</span>
                        </div>
                    </div>
                    <span class="badge" id="urlPlatformBadge"></span>
                </div>
                <div class="col-md-9">
                    <p class="mb-3" id="urlSummary"></p>
                    <div class="insight-section working">
                        <strong class="text-success small"><i class="bi bi-check-circle"></i> What's Working</strong>
                        <ul class="mb-0 small" id="urlWorking"></ul>
                    </div>
                    <div class="insight-section improve">
                        <strong class="text-warning small"><i class="bi bi-exclamation-triangle"></i> Needs Improvement</strong>
                        <ul class="mb-0 small" id="urlImprove"></ul>
                    </div>
                    <div class="insight-section actions">
                        <strong style="color:#7209b7" class="small"><i class="bi bi-lightning"></i> Action Items</strong>
                        <ul class="mb-0 small" id="urlActions"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if account_health %}
<!-- Section B: Health Score Cards -->
<h6 class="text-muted mb-3"><i class="bi bi-heart-pulse"></i> Connected Account Health</h6>
<div class="row g-3 mb-4">
    {% for item in account_health %}
    <div class="col-md-4 col-lg-3">
        <div class="card card-custom score-card h-100">
            <div class="card-body text-center">
                <div class="health-gauge" style="background: conic-gradient({{ item.score.color }} {{ item.score.total * 3.6 }}deg, #e9ecef {{ item.score.total * 3.6 }}deg);">
                    <div class="health-gauge-inner">
                        <span class="score" style="color:{{ item.score.color }}">{{ item.score.total }}</span>
                        <span class="label">{{ item.score.label }}</span>
                    </div>
                </div>
                <div class="mb-2">
                    <span class="badge" style="background:{{ item.account.platform_color }}">
                        <i class="bi {{ item.account.platform_icon }}"></i> {{ item.account.platform|capitalize }}
                    </span>
                </div>
                <h6 class="mb-3">{{ item.account.account_name or 'Unnamed' }}</h6>

                <!-- Dimension bars -->
                <div class="text-start small">
                    <div class="d-flex justify-content-between">
                        <span>Engagement</span><span>{{ item.score.dimensions.engagement }}/25</span>
                    </div>
                    <div class="dim-bar"><div class="dim-bar-fill bg-primary" style="width:{{ (item.score.dimensions.engagement / 25 * 100)|int }}%"></div></div>

                    <div class="d-flex justify-content-between">
                        <span>Consistency</span><span>{{ item.score.dimensions.consistency }}/25</span>
                    </div>
                    <div class="dim-bar"><div class="dim-bar-fill bg-success" style="width:{{ (item.score.dimensions.consistency / 25 * 100)|int }}%"></div></div>

                    <div class="d-flex justify-content-between">
                        <span>Quality</span><span>{{ item.score.dimensions.quality }}/25</span>
                    </div>
                    <div class="dim-bar"><div class="dim-bar-fill bg-warning" style="width:{{ (item.score.dimensions.quality / 25 * 100)|int }}%"></div></div>

                    <div class="d-flex justify-content-between">
                        <span>Growth</span><span>{{ item.score.dimensions.growth }}/25</span>
                    </div>
                    <div class="dim-bar"><div class="dim-bar-fill" style="width:{{ (item.score.dimensions.growth / 25 * 100)|int }}%;background:#7209b7"></div></div>
                </div>

                <button class="btn btn-sm btn-outline-primary w-100 mt-3" onclick="generateInsights({{ item.account.id }}, this)" {% if not has_api_key %}disabled title="Set OPENAI_API_KEY in .env to enable"{% endif %}>
                    <i class="bi bi-stars"></i> Generate AI Insights
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Section C: Performance Trend -->
<div class="card card-custom mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Performance Trend (8 Weeks)</h6>
            <select class="form-select form-select-sm w-auto" id="trendAccount" onchange="loadTrend(this.value)">
                {% for acc in accounts %}
                <option value="{{ acc.id }}" {{ 'selected' if acc.id == selected_id }}>{{ acc.account_name or acc.platform }} ({{ acc.platform|capitalize }})</option>
                {% endfor %}
            </select>
        </div>
        <canvas id="trendChart" height="80"></canvas>
    </div>
</div>

<!-- Section D: AI Insights Panel -->
<div class="card card-custom mb-4" id="insightsPanelCard" style="display:none;">
    <div class="card-body">
        <h6 class="mb-3"><i class="bi bi-robot"></i> AI Insights — <span id="insightsAccountName"></span></h6>
        <div id="insightsLoading" class="text-center py-4" style="display:none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2 mb-0">Analyzing with GPT...</p>
        </div>
        <div id="insightsContent" style="display:none;">
            <p class="mb-3" id="insightsSummary"></p>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="insight-section working">
                        <strong class="text-success small"><i class="bi bi-check-circle"></i> What's Working</strong>
                        <ul class="mb-0 small" id="insightsWorking"></ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="insight-section improve">
                        <strong class="text-warning small"><i class="bi bi-exclamation-triangle"></i> Needs Improvement</strong>
                        <ul class="mb-0 small" id="insightsImprove"></ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="insight-section actions">
                        <strong style="color:#7209b7" class="small"><i class="bi bi-lightning"></i> Action Items</strong>
                        <ul class="mb-0 small" id="insightsActions"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Empty state -->
<div class="card card-custom">
    <div class="card-body text-center py-5">
        <i class="bi bi-plug text-muted" style="font-size:3rem;"></i>
        <h5 class="mt-3">No Connected Accounts</h5>
        <p class="text-muted">Connect your Facebook, Instagram, or LinkedIn accounts to see health scores and get AI insights.</p>
        <a href="{{ url_for('accounts.connect') }}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Connect Account</a>
    </div>
</div>
{% endif %}

{% if not has_api_key %}
<div class="alert alert-warning mt-3">
    <i class="bi bi-key"></i> <strong>OpenAI API Key Required</strong> — Set <code>OPENAI_API_KEY</code> in your <code>.env</code> file to enable AI-powered insights and page analysis.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
// Platform detection for URL input
function detectPlatform(url) {
    const badge = document.getElementById('url-platform-badge');
    const lower = url.toLowerCase();
    if (lower.includes('facebook.com') || lower.includes('fb.com')) {
        badge.innerHTML = '<i class="bi bi-facebook" style="color:#1877f2"></i>';
    } else if (lower.includes('instagram.com')) {
        badge.innerHTML = '<i class="bi bi-instagram" style="color:#e4405f"></i>';
    } else if (lower.includes('linkedin.com')) {
        badge.innerHTML = '<i class="bi bi-linkedin" style="color:#0a66c2"></i>';
    } else {
        badge.innerHTML = '<i class="bi bi-globe"></i>';
    }
}

// Analyze URL
function analyzeUrl() {
    const url = document.getElementById('pageUrl').value.trim();
    if (!url) return;

    const btn = document.getElementById('analyzeUrlBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';

    const payload = {
        url: url,
        followers: document.getElementById('urlFollowers').value || null,
        avg_likes: document.getElementById('urlAvgLikes').value || null,
        avg_comments: document.getElementById('urlAvgComments').value || null,
        posts_per_week: document.getElementById('urlPostsPerWeek').value || null,
    };

    fetch('{{ url_for("ai_insights.analyze_url") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic"></i> Analyze Page';

        if (data.error) {
            alert(data.error);
            return;
        }

        const score = data.score || 0;
        let color = '#dc3545';
        let label = 'Poor';
        if (score >= 80) { color = '#198754'; label = 'Excellent'; }
        else if (score >= 60) { color = '#4361ee'; label = 'Good'; }
        else if (score >= 40) { color = '#ffc107'; label = 'Average'; }
        else if (score >= 20) { color = '#fd7e14'; label = 'Needs Work'; }

        document.getElementById('urlGauge').style.background =
            `conic-gradient(${color} ${score * 3.6}deg, #e9ecef ${score * 3.6}deg)`;
        document.getElementById('urlScore').textContent = score;
        document.getElementById('urlScore').style.color = color;
        document.getElementById('urlLabel').textContent = label;
        document.getElementById('urlSummary').textContent = data.summary || '';

        renderList('urlWorking', data.what_is_working || []);
        renderList('urlImprove', data.needs_improvement || []);
        renderList('urlActions', data.action_items || []);

        document.getElementById('urlResult').style.display = 'block';
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic"></i> Analyze Page';
        alert('Failed to analyze page. Check your API key and try again.');
    });
}

// Generate insights for connected account
function generateInsights(accountId, btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    const panel = document.getElementById('insightsPanelCard');
    panel.style.display = 'block';
    document.getElementById('insightsLoading').style.display = 'block';
    document.getElementById('insightsContent').style.display = 'none';

    // Find account name from card
    const card = btn.closest('.card-body');
    const name = card.querySelector('h6').textContent;
    document.getElementById('insightsAccountName').textContent = name;

    panel.scrollIntoView({behavior: 'smooth', block: 'center'});

    fetch('{{ url_for("ai_insights.generate") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: accountId}),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Generate AI Insights';
        document.getElementById('insightsLoading').style.display = 'none';

        if (data.error) {
            alert(data.error);
            panel.style.display = 'none';
            return;
        }

        document.getElementById('insightsSummary').textContent = data.summary || '';
        renderList('insightsWorking', data.what_is_working || []);
        renderList('insightsImprove', data.needs_improvement || []);
        renderList('insightsActions', data.action_items || []);
        document.getElementById('insightsContent').style.display = 'block';
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Generate AI Insights';
        document.getElementById('insightsLoading').style.display = 'none';
        panel.style.display = 'none';
        alert('Failed to generate insights.');
    });
}

function renderList(elementId, items) {
    const ul = document.getElementById(elementId);
    ul.innerHTML = '';
    items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
    });
}

// Trend chart
const trendData = {{ trend|tojson }};
let trendChart = null;

function initTrendChart(data) {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;

    if (trendChart) trendChart.destroy();

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.week),
            datasets: [
                {
                    label: 'Engagement',
                    data: data.map(d => d.engagement),
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67,97,238,0.1)',
                    fill: true,
                    tension: 0.3,
                    yAxisID: 'y',
                },
                {
                    label: 'Posts',
                    data: data.map(d => d.posts),
                    borderColor: '#7209b7',
                    backgroundColor: 'rgba(114,9,183,0.1)',
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y1',
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top' } },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Engagement' },
                    beginAtZero: true,
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Posts' },
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                }
            }
        }
    });
}

function loadTrend(accountId) {
    fetch(`{{ url_for("ai_insights.trend") }}?account_id=${accountId}`)
        .then(r => r.json())
        .then(data => initTrendChart(data));
}

// Init chart on page load
if (trendData && trendData.length) {
    initTrendChart(trendData);
}
</script>
{% endblock %}
