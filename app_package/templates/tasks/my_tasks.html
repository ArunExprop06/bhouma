{% extends "base.html" %}
{% block title %}My Tasks{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
        <h2><i class="bi bi-check2-square"></i> My Tasks</h2>
        <p>{{ today.strftime('%A, %d %B %Y') }}</p>
    </div>
    <a href="{{ url_for('daily_tasks.whatsapp_qr') }}" class="btn btn-success">
        <i class="bi bi-whatsapp"></i> WhatsApp Report
    </a>
</div>

<!-- Progress Bar -->
<div class="card-custom mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-semibold">Today's Progress</span>
            <span id="progressLabel" class="fw-bold text-primary-custom">{{ done }}/{{ total }} ({{ pct }}%)</span>
        </div>
        <div class="progress completion-bar" style="height:12px;">
            <div id="progressBar" class="progress-bar bg-primary-gradient" role="progressbar"
                 style="width:{{ pct }}%" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
</div>

{% if not instances %}
<div class="empty-state">
    <i class="bi bi-clipboard-check d-block"></i>
    <h5>No tasks assigned yet</h5>
    <p>Your admin hasn't assigned any tasks to you. Check back later.</p>
</div>
{% else %}

{% set platform_labels = {'facebook':'Facebook','instagram':'Instagram','linkedin':'LinkedIn','general':'General'} %}
{% set platform_order = ['facebook','instagram','linkedin','general'] %}

{% for plat in platform_order %}
{% if plat in grouped %}
<h6 class="text-uppercase text-muted mb-2 mt-3" style="letter-spacing:1px;font-size:0.75rem;">
    <i class="bi {{ grouped[plat][0].template.platform_icon }}" style="color:{{ grouped[plat][0].template.platform_color }}"></i>
    {{ platform_labels[plat] }}
</h6>

{% for inst in grouped[plat] %}
<div class="task-item {{ 'completed' if inst.is_completed }}" id="task-{{ inst.id }}">
    <div class="d-flex align-items-center gap-3">
        <label class="task-checkbox" onclick="event.preventDefault(); toggleTask({{ inst.id }})">
            <input type="checkbox" {{ 'checked' if inst.is_completed }} tabindex="-1">
            <span class="checkmark"></span>
        </label>
        <div class="flex-grow-1">
            <div class="task-title">{{ inst.template.title }}</div>
            {% if inst.template.description %}
            <div class="task-desc text-muted small">{{ inst.template.description }}</div>
            {% endif %}
            <div class="mt-1">
                <input type="text" class="form-control form-control-sm task-notes-input"
                       placeholder="Add a note..." value="{{ inst.notes or '' }}"
                       onchange="saveNotes({{ inst.id }}, this.value)"
                       style="max-width:400px;">
            </div>
        </div>
        <div class="text-end">
            {% if inst.is_completed and inst.completed_at %}
            <span class="badge bg-success"><i class="bi bi-check2"></i> Done</span>
            <div class="small text-muted">{{ inst.completed_at.strftime('%H:%M') }}</div>
            {% else %}
            <span class="badge bg-light text-muted">Pending</span>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
{% endif %}
{% endfor %}

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function toggleTask(id) {
    fetch(`/tasks/${id}/toggle`, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(d => {
        if (!d.ok) return;
        const el = document.getElementById('task-' + id);
        const cb = el.querySelector('.task-checkbox input');
        const badge = el.querySelector('.text-end');
        if (d.completed) {
            el.classList.add('completed');
            cb.checked = true;
            badge.innerHTML = '<span class="badge bg-success"><i class="bi bi-check2"></i> Done</span><div class="small text-muted">Just now</div>';
        } else {
            el.classList.remove('completed');
            cb.checked = false;
            badge.innerHTML = '<span class="badge bg-light text-muted">Pending</span>';
        }
        document.getElementById('progressLabel').textContent = `${d.done}/${d.total} (${d.pct}%)`;
        const bar = document.getElementById('progressBar');
        bar.style.width = d.pct + '%';
        bar.setAttribute('aria-valuenow', d.pct);
    });
}

function saveNotes(id, val) {
    const fd = new FormData();
    fd.append('notes', val);
    fetch(`/tasks/${id}/notes`, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: fd
    });
}
</script>
{% endblock %}
